---
lab:
    title: '15 - Azure Sentinel'
    module: 'Module 04 - Manage security operations'
---

# Lab 15 - Azure Sentinel

# Student lab manual

## Lab scenario

Azure Sentinel is your bird's-eye view across the enterprise. Put the cloud and large-scale intelligence from decades of Microsoft security experience to work. Make your threat detection and response smarter and faster with artificial intelligence (AI).

Contoso would now like to create a Proof of concept with Azure Sentinel to assess it as a SIEM and a SOAR. 

## Objectives

Using the VM and the Log Analytics workspace you created in the Azure Monitor lab, Contoso would like you to spin up an Azure Sentinel instance. In addition Contoso would like you to 
- Start collecting data from Azure Activity and Security Center.
- Add some alerts both built in and custom
- Show hw Playbooks can be used to automate a response to an incident.
Below is a lost of the objectives for this proof of concept.


+ Task 1: Enable Azure Sentinel
+ Task 2: Connect data sources
+ Task 3: Configure Analytics
+ Task 4: Create a new Playbook in Logic Apps.
+ Task 5: Create a custom alert and configure a Playbook as an automated response.
+ Task 6 : Invoke an incident
+ Task 7 : Remove Resources

## Instructions

## Exercise 1: On-board Azure Sentinel


To on-board Azure Sentinel, you first need to enable Azure Sentinel, and then connect your data sources. Azure Sentinel comes with a number of connectors for Microsoft solutions, available out of the box and providing real-time integration, including Microsoft Threat Protection solutions, Microsoft 365 sources, including Office 365, Azure AD, Azure ATP, and Microsoft Cloud App Security, and more. In addition, there are built-in connectors to the broader security ecosystem for non-Microsoft solutions. You can also use common event format, Syslog or REST-API to connect your data sources with Azure Sentinel.  

After you connect your data sources, choose from a gallery of expertly created workbooks that surface insights based on your data. These workbooks can be easily customized to your needs.


### Task 1: Enable Azure Sentinel

1.  In the Azure portal, select **All Services** search for **Azure Sentinel**. Select **Azure Sentinel**
1.  Click **Connect workspace**.

1. Choose the Log Analytics workspace**myWorkspaceDemo(yourname)** from the Azure Monitor Lab we created earlier

1. Click **Add Azure Sentinel**

    **Note**: </br> - Default workspaces created by Azure Security Center will not appear in the list; you can't install Azure Sentinel on them. </br> - Azure Sentinel can run on workspaces in any GA region of Log Analytics except the China, Germany and Azure Government regions. Data generated by Azure Sentinel (such as incidents, bookmarks, and alert rules, which may contain some customer data sourced from these workspaces) is saved either in West Europe (for workspaces located in Europe) or East US (for all US-based workspaces, as well as any other region except Europe).

### Task 2: Connect data sources


Azure Sentinel creates connections to services and apps by connecting to the service and forwarding the events and logs to Azure Sentinel. For machines and virtual machines, you can install the Azure Sentinel agent that collects the logs and forwards them to Azure Sentinel. For Firewalls and proxies, Azure Sentinel utilizes a Linux Syslog server. The agent is installed collects the log files and forwards them to Azure Sentinel. 


1. Under **Configuration** select **Data connectors**. This page lets you see the full list of connectors that Azure Sentinel provides and their status.

1.  Select **Azure Activity** and click **Open connector page**.

1.  Select **Configure Azure Activity logs**.

1. Click on **your subscription** and click **Connect**

1. go back to the connector page

1. Under **Configuration** select **Data connectors**. This page lets you see the full list of connectors that Azure Sentinel provides and their status.

1.  Select **Azure Activity** 

1. You should see a summary of the data in the **Data received** graph, and connectivity status of the data types. (Note it may take some time for data to start cming through)

1. Under **Configuration** select **Data connectors**. This page lets you see the full list of connectors that Azure Sentinel provides and their status.

1. Select **Azure Security Center** and click **Open connector page**.

1. SelectNext to your subscription select **Connect** then under Create incidents click **Enable**


### Task 3: Configure Analytics

1. Under **Configuration** select **Analytics**. 

1. Click **Rule templates**

1. take a minute to look through the types of Rules you can create from here includong the Data Sources. Sort by **Data Sources** and select **Suspicious number of resource creation or deployment** click **Create Rule** .

1. Accept the defaults and click **Next: Set rule logic**

1. Accept the defaults and click **Next: Incident settings**

1. Accept the defaults and click **Next: Automated response**

1. This is where we can add a playbook(Logic App) to a rule to automate the remediation of an issue.

1. Click **Next: Review**

1. Click **Create**

1. We should now see a new Active rule.

### Task 4 Create a new Playbook in Logic Apps.

1. First we need to deploy a new Login app. Select **Create a new resource** and type **template** then select **Template deployment (deploy using custom templates)** > Click **Create** > **Build your own template in the editor** 

1. select **Load file** and choose **2020\Allfiles\Labs\LAB_15\azuredeploy.json** > Click **Open** > Click **Save**

     > Note you can find many PLaybook and other Azure Sentinel examples in the following Github Repository. https://github.com/Azure/Azure-Sentinel/tree/master/Playbooks 

1. Choose the following settings 

   |Setting  |Value  |
   |---------|---------|
   |Subscription | your subscription |
   |Resource group | AZ500LAB131415 |
   |Region | East US |
   |Playbook Name | Change-Incident-Severity|
   |User Name | your subscriptions global admin account upn.)

1. Select ***I agree ....*** > Click **Purchase**

1. once the deployment is complete (in the bell icon) **click on go to resource group**

1. Select the new Logic app **Change-Incident-Severity**

1. Click **Edit**

1. Click on the first trigger called **Connections** > Select **Add new**

1. Ensure you have your default directory that has your Azure Sentinel installed. and click **Sign in**

1. Sign in with your subscriptions account.

1. Now repeat this process for the other actions beneath this called Connections(Inlcluding the one in the If tru statement). except you will need to simply select the new connection.

1. Once all steps do not show a warning symbol click **Save**

1. In this lab we wont be able to produce an incident but we can show how to connect an alert rule with a playbook(Logic App)


### Task 5 Create a custom alert and configure a Playbook as an automated response.

1. navigate to **All Services** and type in **Azure Sentinel** > Select **Azure Sentinel**

1. Select the **myWorkspaceDemo(yourname)**

1. Under **Configuration** select **Analytics**.

1. Click **Create** > **Scheduled query rule**

1. Fill in the following details

   |Setting  |Value  |
   |---------|---------|
   |Name  | Playbook Demo |
   | Tactics | Initial Access |

1. Click **Next: Set rule logic**

1. in Rule query paste in the following query which will tell us when somebody makes a change to Just In Time rules.

     ```
     AzureActivity
     | where ResourceProviderValue == "Microsoft.Security" 
     | where Category == "Security" 
     | where OperationNameValue == "Microsoft.Security/locations/jitNetworkAccessPolicies/write" 
     ```
1. Under **Query scheduling** Change **Run query every** to **5 minutes**

1. Click **Next:Incident Settings**

1. leave at default and click **Next:Automated response**

1. Select **Change-Incident-Severity** then click **Next:Review** 

1. Click **Create**

1. You should now see a new Alert called **Playbook Demo**. Note that when this incident occurs it should have a medium level severity

### Task 6 : Invoke an incident

1. Navigate to **Security Center**

1. Under **Advanced cloud defense** select **Just in time VM access**

1. Select **myVM** then click on the **elipsis** and select **Remove** > then **Yes**

1. Navigate to **Monitor** > **Activity Log** You should see an entry showing **Delete JIT Network Access Policies** (You maye need to wait a few minutes)

1. navigate to **All Services** and type in **Azure Sentinel** > Select **Azure Sentinel**

1. Select the **myWorkspaceDemo(yourname)**

1. you should see in the dashboard a few Alerts that have just occured.

1. Click on **Threat Management** > **Incidents**

1. We can see that we have multiple Incidents at Medium severity lebel.

1. wait at least 5 minutes until the playbook is invoked. you can check the run status under **Configuration** > **Playbooks**

1. Once a Playbook has been involed it will show the status , Runs, Suvveeded Failed attempts.

1. When the runbook has completed go back to **Incidents** and we can see that our incidents have been escalated to a **High** Severity

1. If we want to manually change the severity or Status of an incident we can simply select the incident and click on **Actions**.

1. Then we can choose the Severity level and the Status of the Incodent.

**Results**: You have now completed this lab.

### Task 7: Remove resources.

1. Open Cloud Shell in Powershell

1.  Remove the resource group by running the following command (When prompted to confirm press Y and press enter):(Use the Resource Group names that werecreated in your lab)
    ```powershell
    Remove-AzResourceGroup -Name "AZ500LAB131415"
    ```

1. Close the **Cloud Shell** prompt at the bottom of the portal.

> **Result**: In this exercise, you removed the resources used in this lab.
